<!-- List Discovered Devices -->
<link rel="stylesheet" href="./styles.css">
<div class="container">
  <h2 data-i18n="pair.list_devices.title"></h2>
  <div id="devices-list"></div>
</div>

<script>
  Homey.showLoadingOverlay();
  // Get devices from either the stored list or request new list
  (window.discoveredDevices ? Promise.resolve(window.discoveredDevices) : Homey.emit('list_devices')).then(devices => {
    Homey.hideLoadingOverlay();
    const container = document.getElementById('devices-list');
    
    if (devices && devices.length > 0) {
      const ul = document.createElement('ul');
      devices.forEach(device => {
        const li = document.createElement('li');
        const deviceData = JSON.stringify(device).replace(/'/g, "&#39;");
        console.log(device);
        li.innerHTML = `
          <div class="device-info">
            <div class="device-name">${device.name || 'Tuya Doorbell'}</div>
            <div class="device-details">ID: ${device.data?.id || device.settings?.deviceId || 'Unknown'}</div>
            <div class="device-details">IP: ${device.settings?.ipAddress || 'Unknown'}</div>
          </div>
          <button class="homey-button-primary" onclick='Homey.emit("add_device", {"data": {"id": "${device.data.id}"}, "name": "${device.name}"}).then(() => { Homey.done(); }).catch((err) => { Homey.alert(err.message || "Failed to add device"); })'>Add Device</button>
        `;
        ul.appendChild(li);
      });
      container.appendChild(ul);
    } else {
      const p = document.createElement('p');
      p.setAttribute('data-i18n', 'pair.list_devices.no_devices_found');
      container.appendChild(p);
    }
  }).catch(error => {
    Homey.hideLoadingOverlay();
    Homey.alert(error);
  });
</script>
