<!-- Device Discovery Screen -->
<div class="container">
  <h2 data-i18n="pair.discovery.title"></h2>
  <p data-i18n="pair.discovery.instructions"></p>
  
  <form id="discovery-form">
    <div class="form-group">
      <label data-i18n="pair.manual_settings.fields.0.label"></label>
      <input type="text" name="deviceId" required />
    </div>
    <div class="form-group">
      <label data-i18n="pair.manual_settings.fields.1.label"></label>
      <input type="password" name="localKey" required />
    </div>
    <button type="submit" class="button" data-i18n="pair.discovery.start_scan"></button>
  </form>

  <div id="searching" style="display: none;">
    <div class="spinner"></div>
    <p data-i18n="pair.discovery.scanning"></p>
  </div>
</div>

<script>
  document.getElementById('discovery-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
      deviceId: formData.get('deviceId'),
      localKey: formData.get('localKey')
    };

    document.getElementById('discovery-form').style.display = 'none';
    document.getElementById('searching').style.display = 'block';
    Homey.showLoadingOverlay();

    try {
      // Set a longer timeout (30 seconds)
      const result = await Promise.race([
        Homey.emit('search_auto', data),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error(Homey.__('errors.discovery_timeout'))), 30000)
        )
      ]);
      console.log('Discovery response:', result);
      if (result && Array.isArray(result) && result.length > 0) {
        // Store the discovered devices
        window.discoveredDevices = result;
        // Navigate to list_devices view
        Homey.showView('list_devices');
      } else {
        Homey.hideLoadingOverlay();
        document.getElementById('searching').style.display = 'none';
        document.getElementById('discovery-form').style.display = 'block';
        Homey.alert(Homey.__('errors.no_devices_found'));
      }
    } catch (error) {
      Homey.hideLoadingOverlay();
      document.getElementById('searching').style.display = 'none';
      document.getElementById('discovery-form').style.display = 'block';
      Homey.alert(error.message || Homey.__('errors.discovery_failed'));
      console.error('Discovery error:', error);
    }
  });
</script>
